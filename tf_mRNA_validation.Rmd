---
title: "TF-mRNAs"
author: "Phuc Dai Huynh"
date: "11/30/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("./Scripts/require_packages.R")

require.packages(c("ini", 'readxl', 'dplyr'))

require.bio_packages(c('org.Hs.eg.db', 'AnnotationFuncs'))

# Read config file
config <- read.ini('./Configs/tf_mRNAs.ini')
```

```{r}
# ==== 1. Load groups ====
load(file=config$groups$epigroups)
load(file=config$groups$mesgroups)

# ==== 2. Load databases ====
tfs <- read.csv(config$databases$hg19)

ppi_db <- read_xls(config$databases$PPI, sheet='S6')
ppi_db %>%
  dplyr::rename(input = 'Input-node Gene Symbol',
         output = 'Output-node Gene Symbol') %>%
  dplyr::select(input, output) -> ppi_db

trrust_db <- read.table(config$databases$TRRUST, sep='\t', header=F)
trrust_db %>%
  dplyr::rename(input = V1,
         output = V2) %>%
  dplyr::select(input, output) -> trrust_db

load(file=config$databases$STRING)
load(file=config$databases$Reactome)
load(file=config$databases$TRED)
load(file=config$databases$ENCODE)
```


```{r}
get_tf <- function(groups) {
  results <- list()
  for (group in groups) {
    tfs %>%
      dplyr::filter(Symbol %in% group) %>%
      pull(Symbol) -> result
  
    results[[length(results) + 1]] <- result
  }
  return(results)
}

get_tf_binding_genes <- function(groups, database) {
  results <- list()
  
  for (group in groups) {
    if (!is.na(as.integer(names(database)[1]))) {
      tfs %>%
        dplyr::filter(Symbol %in% group) %>%
        pull(EntrezGene) -> entrez_id
      
      matched_entrez_id <-
        names(database)[which(names(database) %in% c(as.character(entrez_id)))]
    } else {
      print(names(database))
      print(group)
      matched_entrez_id <-
        names(database)[which(names(database) %in% c(as.character(group)))]
    }
    
    if (length(matched_entrez_id) == 0) {
      results[[length(results) + 1]] <- vector()
      next
    }
    validated_binding <- database[[matched_entrez_id]]
    
    result <- as.vector(unlist(translate(validated_binding, org.Hs.egSYMBOL)))
    
    results[[length(results) + 1]] <- result
  }
  
  return(results)
}

validate_internal_TF_mRNA <- function(tf_groups, gene_groups, database) {
  results <- list()
  for (i in (1:(length(tf_groups)))) {
    for (j in 1:length(gene_groups)) {
      if (i != j) {
        print(paste(i, '-', j))
        print(tf_groups[[i]])
        database  %>%
          dplyr::filter((input %in% tf_groups[[i]]) &
                           (output %in% gene_groups[[j]])) -> result
        
        results[[length(results) + 1]] <- result
      }
    }
  }
  
  return(results)
}

validate_internal_TF_mRNA_by_entrezids <- function(tf_groups, gene_groups, database) {
  results <- list()
  
  bindings <- get_tf_binding_genes(tf_groups, database)
  for (i in (1:(length(bindings)))) {
    for (j in 1:length(gene_groups)) {
      if (i != j) {
        print(paste(i, '-', j))
        result <- gene_groups[[j]][which(gene_groups[[j]] %in% bindings[[i]])]
        results[[length(results) + 1]] <- result
      }
    }
  }
  
  return(results)
}
```

```{r}
tf_in_epi_groups <- get_tf(epi_groups)
tf_in_epi_groups

epi_gropup_binding_ppi <- validate_internal_TF_mRNA(tf_in_epi_groups, epi_groups, ppi_db)
epi_gropup_binding_ppi

epi_gropup_binding_trrust <- validate_internal_TF_mRNA(tf_in_epi_groups, epi_groups, trrust_db)
epi_gropup_binding_trrust

epi_gropup_binding_string <- validate_internal_TF_mRNA_by_entrezids(tf_in_epi_groups, epi_groups, String_Gene_Gene)
epi_gropup_binding_string

epi_gropup_binding_reactome <- validate_internal_TF_mRNA_by_entrezids(tf_in_epi_groups, epi_groups, Reactome_Gene_Gene)
epi_gropup_binding_reactome

epi_gropup_binding_encode <- validate_internal_TF_mRNA_by_symbols(tf_in_epi_groups, epi_groups, ENCODE)
epi_gropup_binding_encode
```

```{r}
tf_in_mes_groups <- get_tf(mes_groups)
tf_in_mes_groups

mes_gropup_binding_ppi <- validate_internal_TF_mRNA(tf_in_mes_groups, mes_groups, ppi_db)
mes_gropup_binding_ppi

mes_gropup_binding_trrust <- validate_internal_TF_mRNA(tf_in_mes_groups, mes_groups, trrust_db)
mes_gropup_binding_trrust

mes_gropup_binding_string <- validate_internal_TF_mRNA_by_entrezids(tf_in_mes_groups, mes_groups, String_Gene_Gene)
mes_gropup_binding_string

mes_gropup_binding_reactome <- validate_internal_TF_mRNA_by_entrezids(tf_in_mes_groups, mes_groups, Reactome_Gene_Gene)
mes_gropup_binding_reactome

mes_gropup_binding_reactome <- validate_internal_TF_mRNA_by_entrezids(tf_in_mes_groups, mes_groups, Reactome_Gene_Gene)
mes_gropup_binding_reactome

mes_gropup_binding_encode <- validate_internal_TF_mRNA_by_symbols(tf_in_mes_groups, mes_groups, ENCODE)
mes_gropup_binding_encode
```
```
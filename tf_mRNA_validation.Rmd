---
title: "TF-mRNAs"
author: "Phuc Dai Huynh"
date: "11/30/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=F}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

source("./Scripts/require_packages.R")

require.packages(c("ini", 'readxl', 'dplyr'))

require.bio_packages(c('org.Hs.eg.db', 'AnnotationFuncs'))

# Read config file
config <- read.ini('./Configs/tf_mRNAs.ini')
```

```{r}
# ==== 1. Load groups ====
load(file=config$groups$epigroups)
load(file=config$groups$mesgroups)

# ==== 2. Load databases ====
tfs <- read.csv(config$databases$hg19)

ppi_db <- read_xls(config$databases$PPI, sheet='S6')
ppi_db %>%
  dplyr::rename(input = 'Input-node Gene Symbol',
         output = 'Output-node Gene Symbol') %>%
  dplyr::select(input, output) -> ppi_db

trrust_db <- read.table(config$databases$TRRUST, sep='\t', header=F)
trrust_db %>%
  dplyr::rename(input = V1,
         output = V2) %>%
  dplyr::select(input, output) -> trrust_db

load(file=config$databases$ENCODE)
load(file=config$databases$TRED)
load(file=config$databases$STRING)
```

```{r}
validate_internal_TF_mRNA <- function(group, database) {
  results <- list()
  for (i in (1:(length(group)))) {
    for (j in 1:length(group)) {
      if (i != j) {
        print(paste(i, '-', j))
        database  %>%
          dplyr::filter((input %in% group[[i]]) &
                           (output %in% group[[j]])) -> result
        
        results[[length(results) + 1]] <- result
      }
    }
  }
  
  return(results)
}
```

```{r}
get_tf <- function(groups) {
  results <- list()
  for (group in groups) {
    tfs %>%
      dplyr::filter(Symbol %in% group) -> result
  
    results[[length(results) + 1]] <- result
  }
  return(results)
}

get_tf_binding_genes <- function(entrez_id) {
  matched_entrez_id <- names(String_Gene_Gene)[which(names(String_Gene_Gene) %in% c(as.character(entrez_id)))]
  
  if (length(matched_entrez_id) == 0) {
    return(c())
  }
  validated_binding <- String_Gene_Gene[[matched_entrez_id]]
  
  gene_symbols <- as.vector(unlist(translate(validated_binding, org.Hs.egSYMBOL)))
  
  return(gene_symbols)
}

```

```{r}
epi_gropup_binding_ppi <- validate_internal_TF_mRNA(epi_groups, ppi_db)
epi_gropup_binding_ppi

epi_gropup_binding_trrust <- validate_internal_TF_mRNA(epi_groups, trrust_db)
epi_gropup_binding_trrust

mes_gropup_binding_ppi <- validate_internal_TF_mRNA(mes_groups, ppi_db)
mes_gropup_binding_ppi

mes_gropup_binding_trrust <- validate_internal_TF_mRNA(mes_groups, trrust_db)
mes_gropup_binding_trrust
```

```{r}
tf_in_epi_groups <- get_tf(epi_groups)
tf_in_epi_groups

epi_genes <- unlist(epi_groups)

tfs %>%
  dplyr::select(EntrezGene, Symbol) %>%
  dplyr::filter(Symbol %in% unlist(epi_groups)) -> epi_tfs

tf_bindings <- sapply(epi_tfs$EntrezGene, FUN=get_tf_binding_genes)
names(tf_bindings) <- epi_tfs$Symbol
```

```{r}
tf_in_mes_groups <- get_tf(mes_groups)
tf_in_mes_groups

mes_genes <- unlist(mes_groups)

tfs %>%
  dplyr::select(EntrezGene, Symbol) %>%
  dplyr::filter(Symbol %in% unlist(mes_groups)) -> mes_tfs

mes_non_tfs <- mes_genes[-which(mes_genes %in% mes_tfs$Symbol)]
  
tf_bindings <- sapply(mes_tfs$EntrezGene, FUN=get_tf_binding_genes)
names(tf_bindings) <- mes_tfs$Symbol

mes_non_tfs[which(mes_non_tfs %in% as.vector(unlist(tf_bindings)))]
```